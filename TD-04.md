### TD-04 : Gestion d’Utilisateurs en Java avec Hashage, Interfaces, et JDBC

---


### **Structure**

```
src/
├── app/
│   ├── Main.java
├── controllers/
│   ├── UserController.java
├── exceptions/
│   ├── DatabaseException.java
│   ├── UserNotFoundException.java
│   ├── AuthenticationException.java
├── interfaces/
│   ├── IUserRepository.java
│   ├── IUserService.java
├── models/
│   ├── User.java
├── repositories/
│   ├── UserRepository.java
├── services/
│   ├── UserService.java
├── utils/
│   ├── DatabaseConnection.java
│   ├── PasswordHasher.java
├── views/
│   ├── UserView.java
```

---

### **Ajout du Package `exceptions`**

#### **DatabaseException.java**
```java
package exceptions;

public class DatabaseException extends RuntimeException {
    public DatabaseException(String message, Throwable cause) {
        super(message, cause);
    }
}
```

#### **UserNotFoundException.java**
```java
package exceptions;

public class UserNotFoundException extends RuntimeException {
    public UserNotFoundException(String message) {
        super(message);
    }
}
```

#### **AuthenticationException.java**
```java
package exceptions;

public class AuthenticationException extends RuntimeException {
    public AuthenticationException(String message) {
        super(message);
    }
}
```

---

### **Modifications des Classes Existantes**

#### **UserRepository.java**
```java
package repositories;

import exceptions.DatabaseException;
import interfaces.IUserRepository;
import models.User;
import utils.DatabaseConnection;

import java.sql.*;
import java.util.ArrayList;
import java.util.List;

public class UserRepository implements IUserRepository {
    @Override
    public List<User> getAllUsers() {
        String query = "SELECT id, username FROM users";
        List<User> users = new ArrayList<>();
        try (Connection connection = DatabaseConnection.getConnection();
             Statement statement = connection.createStatement();
             ResultSet resultSet = statement.executeQuery(query)) {
            while (resultSet.next()) {
                users.add(new User(resultSet.getInt("id"), resultSet.getString("username"), null));
            }
        } catch (SQLException e) {
            throw new DatabaseException("Error fetching users from the database.", e);
        }
        return users;
    }

    @Override
    public void addUser(User user) {
        String query = "INSERT INTO users (username, password) VALUES (?, ?)";
        try (Connection connection = DatabaseConnection.getConnection();
             PreparedStatement preparedStatement = connection.prepareStatement(query)) {
            preparedStatement.setString(1, user.getUsername());
            preparedStatement.setString(2, user.getPassword());
            preparedStatement.executeUpdate();
        } catch (SQLException e) {
            throw new DatabaseException("Error adding user to the database.", e);
        }
    }

    @Override
    public boolean authenticateUser(String username, String hashedPassword) {
        String query = "SELECT * FROM users WHERE username = ? AND password = ?";
        try (Connection connection = DatabaseConnection.getConnection();
             PreparedStatement preparedStatement = connection.prepareStatement(query)) {
            preparedStatement.setString(1, username);
            preparedStatement.setString(2, hashedPassword);
            try (ResultSet resultSet = preparedStatement.executeQuery()) {
                return resultSet.next();
            }
        } catch (SQLException e) {
            throw new DatabaseException("Error during user authentication.", e);
        }
    }

    @Override
    public void deleteUser(int userId) {
        String query = "DELETE FROM users WHERE id = ?";
        try (Connection connection = DatabaseConnection.getConnection();
             PreparedStatement preparedStatement = connection.prepareStatement(query)) {
            preparedStatement.setInt(1, userId);
            int affectedRows = preparedStatement.executeUpdate();
            if (affectedRows == 0) {
                throw new RuntimeException("No user found with ID: " + userId);
            }
        } catch (SQLException e) {
            throw new DatabaseException("Error deleting user from the database.", e);
        }
    }
}
```

---

#### **UserService.java**
```java
package services;

import exceptions.AuthenticationException;
import exceptions.UserNotFoundException;
import interfaces.IUserService;
import interfaces.IUserRepository;
import models.User;
import utils.PasswordHasher;

import java.sql.SQLException;
import java.util.List;

public class UserService implements IUserService {
    private final IUserRepository userRepository;

    public UserService(IUserRepository userRepository) {
        this.userRepository = userRepository;
    }

    @Override
    public List<User> getAllUsers() {
        return userRepository.getAllUsers();
    }

    @Override
    public void addUser(String username, String password) {
        String hashedPassword = PasswordHasher.hashPassword(password);
        userRepository.addUser(new User(0, username, hashedPassword));
    }

    @Override
    public boolean authenticateUser(String username, String password) {
        String hashedPassword = PasswordHasher.hashPassword(password);
        if (!userRepository.authenticateUser(username, hashedPassword)) {
            throw new AuthenticationException("Invalid username or password.");
        }
        return true;
    }

    @Override
    public void deleteUser(int userId) {
        userRepository.deleteUser(userId);
    }
}
```

---

#### **UserController.java**
```java
package controllers;

import interfaces.IUserService;
import repositories.UserRepository;
import services.UserService;
import views.UserView;

public class UserController {
    private final IUserService userService;
    private final UserView userView;

    public UserController() {
        this.userService = new UserService(new UserRepository());
        this.userView = new UserView();
    }

    public void run() {
        boolean running = true;
        while (running) {
            int choice = userView.displayMenu();
            try {
                switch (choice) {
                    case 1 -> userView.displayMessage(userService.getAllUsers().toString());
                    case 2 -> {
                        String username = userView.getUsernameInput();
                        String password = userView.getPasswordInput();
                        userService.addUser(username, password);
                        userView.displayMessage("User added successfully!");
                    }
                    case 3 -> {
                        String username = userView.getUsernameInput();
                        String password = userView.getPasswordInput();
                        if (userService.authenticateUser(username, password)) {
                            userView.displayMessage("Authentication successful!");
                        }
                    }
                    case 4 -> {
                        int userId = userView.getUserIdInput();
                        userService.deleteUser(userId);
                        userView.displayMessage("User deleted successfully!");
                    }
                    case 0 -> running = false;
                    default -> userView.displayMessage("Invalid option!");
                }
            } catch (Exception e) {
                userView.displayMessage("Error: " + e.getMessage());
            }
        }
    }
}
```
---

### **Avantages de cette structure**
- **Interfaces** pour abstraction et modularité.
- **Hashage SHA-256** pour sécuriser les mots de passe.
- **Architecture MVC** pour un code bien structuré et maintenable.
- **Respect des principes SOLID** avec une séparation claire des responsabilités.

